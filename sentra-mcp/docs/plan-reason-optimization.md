# Plan Reason 字段优化文档

## 问题背景

在 Plan 阶段生成的 `reason` 字段经常包含具体的结果预测和数据猜测，导致与实际执行结果不符：

**问题示例**：
```json
{
  "aiName": "local__image_vision_read",
  "reason": "分析引用的图片内容，以便确定合适的表情; 获取三个最能表达图片情绪的QQ表情ID",
  "result": {
    "data": {
      "description": "实际返回的是详细的图片描述..."
    }
  }
}
```

**问题分析**：
- ❌ `reason` 中包含"获取三个表情ID"的具体预测
- ❌ 实际执行结果可能完全不同
- ❌ 造成用户误解和日志混乱

---

## 优化方案

### 核心原则

**reason 字段应该描述"为什么需要调用"，而非"预测会得到什么"**

| 类型 | 说明 | 示例 |
|------|------|------|
| ✅ 正确 | 描述调用理由、目的 | `["识别图片内容", "分析情绪特征"]` |
| ❌ 错误 | 预测结果、数据 | `["获取三个表情ID", "返回76,66,356"]` |

---

## 修改内容

### 1. Schema 定义优化

**文件**: `src/agent/tools/internal/emit_plan.schema.json`

```json
{
  "reason": { 
    "type": "array",
    "items": { "type": "string" },
    "description": "调用该工具的理由（数组格式）。每项应简洁描述使用该工具的目的和必要性，不要包含具体的结果预测或数据猜测。示例：[\"分析图片内容\", \"识别情绪特征\"] 而非 [\"获取三个表情ID\"]。重点说明为什么需要调用，而非预测会得到什么结果。"
  }
}
```

### 2. Prompt 模板优化

**文件**: `src/agent/prompts/emit_plan.json`

```json
{
  "system": "你是一个\"先计划再执行\"的智能体。\n...\n\n⚠️ reason 字段编写要求（重要）：\n- 格式：数组，每项为简短的调用理由\n- 内容：说明「为什么需要调用这个工具」，而非「预测会得到什么结果」\n- 示例（✅ 正确）：[\"识别图片内容\", \"分析情绪特征\"]\n- 示例（❌ 错误）：[\"获取三个表情ID\", \"返回76,66,356\"]\n- 原则：保持笼统、客观，避免具体的数据预测和结果猜测"
}
```

**文件**: `src/agent/prompts/fc_plan_sentra.json`

```json
{
  "zh": "...\n- **reason 字段严格要求数组格式**：每项为简短的调用理由，说明「为什么需要调用这个工具」，而非「预测会得到什么结果」\n  - ✅ 正确示例：[\"识别图片内容\", \"分析情绪特征\"]\n  - ❌ 错误示例：[\"获取三个表情ID\", \"返回76,66,356\"]\n  - 原则：保持笼统、客观，避免具体的数据预测和结果猜测"
}
```

---

## 对比示例

### 图片识别场景

**优化前（❌ 错误）**:
```json
{
  "aiName": "local__image_vision_read",
  "reason": [
    "分析引用的图片内容，以便确定合适的表情",
    "获取三个最能表达图片情绪的QQ表情ID"
  ]
}
```

**优化后（✅ 正确）**:
```json
{
  "aiName": "local__image_vision_read",
  "reason": [
    "识别图片内容和主题",
    "分析图片情绪特征"
  ]
}
```

### 文件操作场景

**优化前（❌ 错误）**:
```json
{
  "aiName": "local__file_read",
  "reason": [
    "读取配置文件",
    "返回JSON格式的配置数据，包含apiKey和baseURL"
  ]
}
```

**优化后（✅ 正确）**:
```json
{
  "aiName": "local__file_read",
  "reason": [
    "读取配置文件内容",
    "获取应用配置信息"
  ]
}
```

### 网络请求场景

**优化前（❌ 错误）**:
```json
{
  "aiName": "local__web_search",
  "reason": [
    "搜索OpenAI最新动态",
    "返回10条搜索结果，包含标题、链接和摘要"
  ]
}
```

**优化后（✅ 正确）**:
```json
{
  "aiName": "local__web_search",
  "reason": [
    "搜索OpenAI相关资讯",
    "获取最新动态信息"
  ]
}
```

---

## 编写指南

### ✅ 好的 reason 特征

1. **笼统性**: 不预测具体数据或结果
2. **目的性**: 说明为什么需要调用
3. **简洁性**: 2-10字的动词短语
4. **客观性**: 避免主观猜测

### ❌ 避免的模式

1. **具体数据预测**: "返回76,66,356"
2. **数量预测**: "获取三个表情ID"
3. **格式预测**: "返回JSON格式数据"
4. **内容预测**: "包含标题、链接和摘要"

### 推荐的动词模式

- **识别**: 识别内容、识别类型、识别特征
- **分析**: 分析数据、分析情绪、分析结构
- **获取**: 获取信息、获取数据、获取状态
- **读取**: 读取文件、读取配置、读取内容
- **搜索**: 搜索资讯、搜索资料、搜索信息
- **处理**: 处理数据、处理请求、处理结果

---

## 相关优化

### 1. overview 字段优化 ✅

**定义**: 计划的整体概述（可选字段）

**编写原则**:
- 简洁说明任务总体目标和执行策略
- 避免过度详细的步骤描述
- 2-3句话最佳

**对比示例**:

| ❌ 错误 | ✅ 正确 |
|---------|---------|
| "第一步识别图片，第二步选择表情，第三步回复群聊" | "分析用户消息内容，识别需求后调用工具完成任务" |
| "使用 image_vision_read 识别图片，然后用 qq_message_emojiLike 贴表情" | "处理图片消息，根据内容情绪做出适当回应" |

**推荐格式**:
```json
{
  "overview": "分析图片内容，根据情绪选择表情并回复群聊"
}
```

---

### 2. nextStep 字段优化 ✅

**定义**: 当前步骤完成后的下一步行动计划（必填字段）

**编写原则**:
- 描述如何使用本步骤的执行结果
- 避免预测具体的结果数据
- 说明"怎么用结果"而非"结果是什么"

**对比示例**:

| ❌ 错误 | ✅ 正确 |
|---------|---------|
| "使用返回的76,66,356这三个表情ID" | "根据识别结果选择合适的表情" |
| "解析返回的JSON数据中的title字段" | "提取搜索结果中的关键信息" |
| "读取response.data.members数组" | "遍历成员列表进行统计分析" |

**推荐格式**:
```json
{
  "nextStep": "根据识别结果选择合适的表情并贴到消息上"
}
```

**更多示例**:
- 文件操作: "根据文件内容确定下一步处理方案"
- 搜索操作: "综合搜索结果形成答案"
- 数据查询: "基于查询结果进行筛选和排序"

---

### 3. draftArgs 字段说明

**定义**: 工具调用的初步参数（必填字段）

**编写原则**:
- 只包含必填参数（`required` 字段）
- 参数值基于上下文推断，不能留空
- 可以使用占位符，但后续 ArgGen 会精确填充

**示例**:
```json
{
  "draftArgs": {
    "images": ["path/to/image.png"],
    "prompt": "描述图片内容"
  }
}
```

**注意**: draftArgs 不在本次优化范围内，保持现有逻辑即可。

---

### 4. 工具 description 优化建议 📋

**原则**: 工具的 description 应该描述"能做什么"（功能），而非"会返回什么"（结果）

详见: [`docs/tool-description-guidelines.md`](./tool-description-guidelines.md)

**快速对比**:

| 工具类型 | ❌ 错误 description | ✅ 正确 description |
|----------|---------------------|---------------------|
| 图片识别 | "识别图片，返回详细描述和3个表情ID" | "读取并描述图片内容，支持在线链接和本地路径" |
| 网络搜索 | "搜索网页，返回10条包含标题、链接、摘要的结果" | "实时网络搜索，快速获取互联网最新信息" |
| 文件读取 | "读取文件，返回UTF-8编码的文本内容" | "读取文件内容，支持多种编码格式" |
| 群成员列表 | "获取群成员列表，返回数组格式的成员信息" | "QQ平台：获取群成员列表" |

**优化优先级**:
1. ⭐ 高优先级: 核心工具、常用工具
2. 🔶 中优先级: 有明显结果预测的工具
3. 🔵 低优先级: description 已经比较合理的工具

---

### 5. meta 字段使用建议

如果需要说明返回结果的格式和示例，应该在 `meta` 字段中：

```json
{
  "name": "image_vision_read",
  "description": "读取并描述图片内容...",
  "meta": {
    "realWorldAction": "识别图像内容",
    "responseStyle": "纯文本",
    "responseExample": "图片中包含：一只猫在阳光下打盹..."
  }
}
```

**字段用途**:
- `realWorldAction`: 对用户的简短说明（日志展示用）
- `responseStyle`: 返回数据的风格（纯文本/JSON/Markdown等）
- `responseExample`: 典型返回示例（帮助 AI 理解返回格式）

---

## 验证方法

### 自检清单

在生成 plan 时，检查每个 reason 是否：

- [ ] 使用数组格式
- [ ] 每项都是简短的动词短语
- [ ] 没有包含具体的数字或数据
- [ ] 没有预测结果的格式或结构
- [ ] 说明了"为什么调用"而非"会得到什么"

### 测试场景

1. **图片识别**: 不预测表情ID数量
2. **文件操作**: 不预测文件格式或内容
3. **网络请求**: 不预测结果数量或字段
4. **数据处理**: 不预测处理结果的具体值

---

## 相关文件

- `src/agent/tools/internal/emit_plan.schema.json` - Schema 定义
- `src/agent/prompts/emit_plan.json` - 标准模式 prompt
- `src/agent/prompts/fc_plan_sentra.json` - FC 模式 prompt
- `src/agent/planners.js` - Plan 执行逻辑
- `src/agent/plan/plan_fc.js` - FC Plan 实现

---

## 预期效果

1. **日志清晰**: reason 不会与实际结果产生混淆
2. **用户理解**: 清楚知道每步的调用目的
3. **维护性**: 代码审查时更容易理解计划意图
4. **可扩展**: 新工具的 reason 编写有明确规范

---

## 注意事项

- 此优化不影响工具的实际执行
- 仅改变 plan 阶段的描述方式
- 与 ArgGen 阶段的 draftArgs 传递无关
- 与工具返回的 result 结构无关
